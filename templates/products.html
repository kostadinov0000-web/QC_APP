<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Управление на продукти</h1>

    {% if role == 'admin' %}
    <!-- Add Product Form -->
    <form method="POST" class="mb-6 bg-white p-4 rounded shadow">
        <input type="hidden" name="action" value="add_product">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="product_name" class="block text-sm font-medium text-gray-700">Име на продукт</label>
                <input type="text" id="product_name" name="product_name" required
                       class="mt-1 block w-full border-2 border-gray-400 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="drawing_number" class="block text-sm font-medium text-gray-700">Номер на чертеж</label>
                <input type="text" id="drawing_number" name="drawing_number" required
                       class="mt-1 block w-full border-2 border-gray-400 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="drawing_path" class="block text-sm font-medium text-gray-700">Път до чертеж (основен)</label>
                <div class="flex space-x-2">
                    <div class="relative flex-1">
                        <input type="text" id="drawing_path_search" placeholder="Търсете чертеж..." 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 pr-8">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <select id="drawing_path" name="drawing_path" class="hidden">
                            <option value="">Без чертеж</option>
                        </select>
                        <div id="drawing_path_dropdown" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none hidden">
                            <div class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-50" data-value="">
                                <span class="block truncate">Без чертеж</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="openUploadModal(1)" 
                            class="mt-1 bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">Качи чертеж</button>
                </div>
            </div>
            <div>
                <label for="drawing_path_2" class="block text-sm font-medium text-gray-700">Път до чертеж (втори, по избор)</label>
                <div class="flex space-x-2">
                    <div class="relative flex-1">
                        <input type="text" id="drawing_path_2_search" placeholder="Търсете чертеж..." 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 pr-8">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <select id="drawing_path_2" name="drawing_path_2" class="hidden">
                            <option value="">Без чертеж</option>
                        </select>
                        <div id="drawing_path_2_dropdown" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none hidden">
                            <div class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-50" data-value="">
                                <span class="block truncate">Без чертеж</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="openUploadModal(2)" 
                            class="mt-1 bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">Качи чертеж</button>
                </div>
            </div>
        </div>
        <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Добави продукт</button>
    </form>
    {% endif %}

    <!-- Search Bar -->
    <div class="mb-6 bg-white p-4 rounded shadow">
        <form method="GET" class="flex items-center space-x-4">
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Търсене в продукти</label>
                <input type="text" id="search" name="search" value="{{ search }}" 
                       placeholder="Търсете по име на продукт, номер на чертеж или коментари..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex space-x-2">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Търси
                </button>
                {% if search %}
                <a href="{{ url_for('products') }}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Изчисти
                </a>
                {% endif %}
            </div>
        </form>
        
        <!-- Results info -->
        {% if search %}
        <div class="mt-2 text-sm text-gray-600">
            Показани {{ products|length }} от {{ total }} резултата за "{{ search }}"
        </div>
        {% else %}
        <div class="mt-2 text-sm text-gray-600">
            Показани {{ products|length }} от {{ total }} продукта (Страница {{ page }} от {{ total_pages }})
        </div>
        {% endif %}
    </div>

    <!-- Products Table -->
    <div class="bg-white p-4 rounded shadow">
        <div class="overflow-x-auto">
            <table id="productsTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Име на продукт</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Номер на чертеж</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Път до чертеж</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Коментари</th>
                    {% if role == 'admin' %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for product in products %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <a href="#" onclick="showDimensionsModal({{ product.id }}, '{{ product.product_name | escape }}')"
                           class="text-blue-600 hover:underline">{{ product.product_name }}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.drawing_number }}</td>
                    <td class="px-6 py-4 break-all text-sm text-gray-500">
                        {% if product.drawing_path %}
                            <div class="mb-1">
                                <span>{{ product.drawing_path }}</span>
                                <a href="/{{ product.drawing_path }}" target="_blank" class="ml-2 text-blue-600 hover:underline">Download</a>
                                <button type="button" class="ml-2 text-yellow-600 hover:text-yellow-800 text-xs" onclick="openReplaceModal({{ product.id }}, '{{ product.drawing_path }}', 1)">Replace</button>
                                <button type="button" class="ml-2 text-red-600 hover:text-red-800 text-xs" onclick="deleteDrawing({{ product.id }}, '{{ product.drawing_path }}', this, 1)">Delete</button>
                            </div>
                        {% endif %}
                        {% if product.drawing_path_2 %}
                            <div>
                                <span>{{ product.drawing_path_2 }}</span>
                                <a href="/{{ product.drawing_path_2 }}" target="_blank" class="ml-2 text-blue-600 hover:underline">Download</a>
                                <button type="button" class="ml-2 text-yellow-600 hover:text-yellow-800 text-xs" onclick="openReplaceModal({{ product.id }}, '{{ product.drawing_path_2 }}', 2)">Replace</button>
                                <button type="button" class="ml-2 text-red-600 hover:text-red-800 text-xs" onclick="deleteDrawing({{ product.id }}, '{{ product.drawing_path_2 }}', this, 2)">Delete</button>
                            </div>
                        {% endif %}
                        {% if not product.drawing_path and not product.drawing_path_2 %}
                            <span class="text-gray-400">None</span>
                            {% if role == 'admin' %}
                            <div class="mt-2">
                                <button type="button" class="text-green-600 hover:text-green-800 text-xs mr-2" onclick="openAddDrawingModal({{ product.id }}, 1)">Add Drawing 1</button>
                                <button type="button" class="text-green-600 hover:text-green-800 text-xs" onclick="openAddDrawingModal({{ product.id }}, 2)">Add Drawing 2</button>
                            </div>
                            {% endif %}
                        {% elif not product.drawing_path %}
                            <div class="text-gray-400">Slot 1: None</div>
                            {% if role == 'admin' %}
                            <button type="button" class="text-green-600 hover:text-green-800 text-xs ml-2" onclick="openAddDrawingModal({{ product.id }}, 1)">Add Drawing 1</button>
                            {% endif %}
                        {% elif not product.drawing_path_2 %}
                            <div class="text-gray-400 mt-1">Slot 2: None</div>
                            {% if role == 'admin' %}
                            <button type="button" class="text-green-600 hover:text-green-800 text-xs ml-2" onclick="openAddDrawingModal({{ product.id }}, 2)">Add Drawing 2</button>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="product-comment">{{ product.comments or 'Няма коментари' }}</span>
                        {% if role == 'admin' %}
                        <button onclick="editComment({{ product.id }}, this)" class="ml-2 text-blue-600 hover:text-blue-800 text-xs">Редактирай</button>
                        <div class="comment-edit-form hidden mt-2">
                            <textarea class="w-full border rounded px-2 py-1 text-sm" rows="3" placeholder="Въведете коментар...">{{ product.comments or '' }}</textarea>
                            <div class="mt-2">
                                <button onclick="saveComment({{ product.id }}, this)" class="text-green-600 hover:text-green-800 text-xs mr-2">Запази</button>
                                <button onclick="cancelCommentEdit(this)" class="text-gray-600 hover:text-gray-800 text-xs">Отказ</button>
                            </div>
                        </div>
                        {% endif %}
                    </td>
                    {% if role == 'admin' %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <form method="POST" class="inline">
                            <input type="hidden" name="action" value="delete_product">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <button type="submit" onclick="return confirm('Изтриване на този продукт?')"
                                    class="text-red-600 hover:text-red-800">Изтрий</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        
        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <div class="mt-6 flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
            <div class="flex flex-1 justify-between sm:hidden">
                {% if has_prev %}
                <a href="{{ url_for('products', page=page-1, search=search) }}" 
                   class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Предишна
                </a>
                {% endif %}
                {% if has_next %}
                <a href="{{ url_for('products', page=page+1, search=search) }}" 
                   class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Следваща
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Показани от <span class="font-medium">{{ ((page-1) * 50) + 1 }}</span> до 
                        <span class="font-medium">{{ ((page-1) * 50) + products|length }}</span> от 
                        <span class="font-medium">{{ total }}</span> резултата
                    </p>
                </div>
                <div>
                    <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                        {% if has_prev %}
                        <a href="{{ url_for('products', page=page-1, search=search) }}" 
                           class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                            </svg>
                        </a>
                        {% endif %}
                        
                        {% for page_num in range(1, total_pages + 1) %}
                            {% if page_num == page %}
                            <span class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
                                {{ page_num }}
                            </span>
                            {% elif page_num <= 3 or page_num >= total_pages - 2 or (page_num >= page - 1 and page_num <= page + 1) %}
                            <a href="{{ url_for('products', page=page_num, search=search) }}" 
                               class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                {{ page_num }}
                            </a>
                            {% elif page_num == 4 and page > 5 %}
                            <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 focus:outline-offset-0">...</span>
                            {% elif page_num == total_pages - 3 and page < total_pages - 4 %}
                            <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 focus:outline-offset-0">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if has_next %}
                        <a href="{{ url_for('products', page=page+1, search=search) }}" 
                           class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Dimensions Modal -->
    <div id="dimensionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalProductName" class="text-xl font-bold"></h2>
                <button onclick="closeDimensionsModal()" class="text-gray-600 hover:text-gray-800">&times;</button>
            </div>
            <!-- Add Dimension Form -->
            <form id="addDimensionForm" class="mb-4">
                <input type="hidden" id="productId" name="product_id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="dimension_name" class="block text-sm font-medium text-gray-700">Име на размер</label>
                        <input type="text" id="dimension_name" name="dimension_name" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="nominal_value" class="block text-sm font-medium text-gray-700">Номинална стойност</label>
                        <input type="number" step="any" id="nominal_value" name="nominal_value" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="tolerance_minus" class="block text-sm font-medium text-gray-700">Толеранс -</label>
                        <input type="number" step="any" id="tolerance_minus" name="tolerance_minus" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="tolerance_plus" class="block text-sm font-medium text-gray-700">Толеранс +</label>
                        <input type="number" step="any" id="tolerance_plus" name="tolerance_plus" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Добави размер</button>
            </form>
            <!-- Dimensions Table -->
            <div class="overflow-x-auto">
                <table id="dimensionsTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Име на размер</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Номинална стойност</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Толеранс -</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Толеранс +</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- Upload Drawing Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Качи чертеж</h2>
                <button onclick="closeUploadModal()" class="text-gray-600 hover:text-gray-800">&times;</button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
                <div>
                    <label for="drawing_file" class="block text-sm font-medium text-gray-700">Изберете PDF файл</label>
                    <input type="file" id="drawing_file" name="drawing_file" accept=".pdf" required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Само PDF файлове са позволени</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeUploadModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Отказ</button>
                    <button type="submit" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Качи</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Replace Drawing Modal -->
    <div id="replaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Replace Drawing</h2>
                <button onclick="closeReplaceModal()" class="text-gray-600 hover:text-gray-800">&times;</button>
            </div>
            <form id="replaceForm" enctype="multipart/form-data" class="space-y-4">
                <input type="hidden" id="replace_product_id" name="product_id">
                <div>
                    <label for="replace_drawing_file" class="block text-sm font-medium text-gray-700">Select New PDF File</label>
                    <input type="file" id="replace_drawing_file" name="drawing_file" accept=".pdf" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Only PDF files are allowed</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeReplaceModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Replace</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Drawing Modal -->
    <div id="addDrawingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add Drawing</h2>
                <button onclick="closeAddDrawingModal()" class="text-gray-600 hover:text-gray-800">&times;</button>
            </div>
            <form id="addDrawingForm" enctype="multipart/form-data" class="space-y-4">
                <input type="hidden" id="add_product_id" name="product_id">
                <input type="hidden" id="add_drawing_slot" name="drawing_slot">
                <div>
                    <label for="add_drawing_file" class="block text-sm font-medium text-gray-700">Select PDF File</label>
                    <input type="file" id="add_drawing_file" name="drawing_file" accept=".pdf" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Only PDF files are allowed</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeAddDrawingModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Drawing</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global array to store all available drawings
let allDrawings = [];

// Global function to populate both drawing path dropdowns
function populateDrawingPath() {
    const drawingPathSelect = document.getElementById('drawing_path');
    const drawingPathSelect2 = document.getElementById('drawing_path_2');
    
    if (!drawingPathSelect || !drawingPathSelect2) {
        console.log('Drawing path selects not found, skipping population');
        return;
    }
    
    fetch('/get_drawings')
        .then(response => response.json())
        .then(pdfFiles => {
            // Store all drawings globally for search functionality
            allDrawings = pdfFiles;
            
            // Save current values
            const currentValue = drawingPathSelect.value;
            const currentValue2 = drawingPathSelect2.value;
            
            // Populate both dropdowns
            populateSearchableDropdown('drawing_path', pdfFiles, currentValue);
            populateSearchableDropdown('drawing_path_2', pdfFiles, currentValue2);
        })
        .catch(error => {
            console.error('Error fetching PDF files:', error);
            allDrawings = [];
        });
}

// Function to populate a searchable dropdown
function populateSearchableDropdown(dropdownId, files, selectedValue = '') {
    const dropdown = document.getElementById(dropdownId + '_dropdown');
    const hiddenSelect = document.getElementById(dropdownId);
    const searchInput = document.getElementById(dropdownId + '_search');
    
    if (!dropdown || !hiddenSelect || !searchInput) return;
    
    // Clear existing options
    dropdown.innerHTML = '';
    hiddenSelect.innerHTML = '<option value="">Без чертеж</option>';
    
    // Add "No drawing" option
    const noDrawingDiv = document.createElement('div');
    noDrawingDiv.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-50';
    noDrawingDiv.setAttribute('data-value', '');
    noDrawingDiv.innerHTML = '<span class="block truncate">Без чертеж</span>';
    if (selectedValue === '') {
        noDrawingDiv.classList.add('bg-blue-100');
        searchInput.value = 'Без чертеж';
    }
    dropdown.appendChild(noDrawingDiv);
    
    // Add file options
    files.forEach(file => {
        const fileValue = `drawings/${file}`;
        
        // Add to hidden select for form submission
        const option = document.createElement('option');
        option.value = fileValue;
        option.textContent = file;
        if (fileValue === selectedValue) {
            option.selected = true;
        }
        hiddenSelect.appendChild(option);
        
        // Add to dropdown
        const fileDiv = document.createElement('div');
        fileDiv.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-50';
        fileDiv.setAttribute('data-value', fileValue);
        fileDiv.innerHTML = `<span class="block truncate">${file}</span>`;
        if (fileValue === selectedValue) {
            fileDiv.classList.add('bg-blue-100');
            searchInput.value = file;
        }
        dropdown.appendChild(fileDiv);
    });
}

// Function to filter dropdown options based on search
function filterDrawings(dropdownId, searchTerm) {
    const dropdown = document.getElementById(dropdownId + '_dropdown');
    if (!dropdown) return;
    
    const items = dropdown.querySelectorAll('[data-value]');
    let visibleCount = 0;
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const matches = text.includes(searchTerm.toLowerCase());
        
        if (matches) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Always show "No drawing" option
    const noDrawingItem = dropdown.querySelector('[data-value=""]');
    if (noDrawingItem) {
        noDrawingItem.style.display = 'block';
    }
}

// Function to setup searchable dropdown functionality
function setupSearchableDropdown(dropdownId) {
    const searchInput = document.getElementById(dropdownId + '_search');
    const dropdown = document.getElementById(dropdownId + '_dropdown');
    const hiddenSelect = document.getElementById(dropdownId);
    
    if (!searchInput || !dropdown || !hiddenSelect) return;
    
    // Show dropdown on focus
    searchInput.addEventListener('focus', () => {
        dropdown.classList.remove('hidden');
    });
    
    // Filter on input
    searchInput.addEventListener('input', (e) => {
        filterDrawings(dropdownId, e.target.value);
        dropdown.classList.remove('hidden');
    });
    
    // Handle item selection
    dropdown.addEventListener('click', (e) => {
        const item = e.target.closest('[data-value]');
        if (!item) return;
        
        const value = item.getAttribute('data-value');
        const text = item.textContent.trim();
        
        // Update search input
        searchInput.value = text;
        
        // Update hidden select
        hiddenSelect.value = value;
        
        // Update visual selection
        dropdown.querySelectorAll('[data-value]').forEach(el => {
            el.classList.remove('bg-blue-100');
        });
        item.classList.add('bg-blue-100');
        
        // Hide dropdown
        dropdown.classList.add('hidden');
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Handle keyboard navigation
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            dropdown.classList.add('hidden');
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            dropdown.classList.remove('hidden');
            const firstVisible = dropdown.querySelector('[data-value]:not([style*="display: none"])');
            if (firstVisible) firstVisible.focus();
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    // Initial population
    populateDrawingPath();
    
    // Setup searchable functionality for both dropdowns
    setupSearchableDropdown('drawing_path');
    setupSearchableDropdown('drawing_path_2');

    // Poll every 5 seconds to refresh dropdown
    setInterval(populateDrawingPath, 5000);

    // Function to check for duplicate products (case-insensitive)
    function checkDuplicateProduct(productName, drawingNumber) {
        console.log('checkDuplicateProduct called with:', productName, drawingNumber);
        // Get all existing products from the table
        const productRows = document.querySelectorAll('#productsTable tbody tr');
        console.log('Found product rows:', productRows.length);
        
        for (let row of productRows) {
            const existingName = row.cells[1].textContent.trim().toLowerCase();
            const existingDrawing = row.cells[2].textContent.trim().toLowerCase();
            console.log('Comparing:', productName.trim().toLowerCase(), 'vs', existingName, 'and', drawingNumber.trim().toLowerCase(), 'vs', existingDrawing);
            
            if (existingName === productName.trim().toLowerCase() && existingDrawing === drawingNumber.trim().toLowerCase()) {
                return {
                    exists: true,
                    existingName: row.cells[1].textContent.trim(),
                    existingDrawing: row.cells[2].textContent.trim()
                };
            }
        }
        
        return { exists: false };
    }
    
    // Add real-time validation to product form
    const productForm = document.querySelector('form[action="/products"]');
    if (productForm) {
        const productNameInput = document.getElementById('product_name');
        const drawingNumberInput = document.getElementById('drawing_number');
        const submitButton = productForm.querySelector('button[type="submit"]');
        
        function validateProduct() {
            console.log('validateProduct called');
            if (!productNameInput || !drawingNumberInput) {
                console.log('Input elements not found');
                return;
            }
            
            const productName = productNameInput.value.trim();
            const drawingNumber = drawingNumberInput.value.trim();
            console.log('Validating:', productName, drawingNumber);
            
            if (productName && drawingNumber) {
                const duplicate = checkDuplicateProduct(productName, drawingNumber);
                console.log('Duplicate result:', duplicate);
                
                // Remove existing error messages
                document.querySelectorAll('.duplicate-error').forEach(el => el.remove());
                
                if (duplicate.exists) {
                    // Show prominent error message below the form
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'duplicate-error mt-4 p-4 bg-red-50 border-l-4 border-red-400 text-red-800 rounded shadow-md';
                    errorDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Дублиран продукт!</h3>
                                <div class="mt-1 text-sm text-red-700">
                                    Продукт с това име и номер на чертеж вече съществува:<br>
                                    <strong>"${duplicate.existingName}"</strong> с номер <strong>"${duplicate.existingDrawing}"</strong>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    drawingNumberInput.parentNode.appendChild(errorDiv);
                    
                    // Also show a toast notification
                    showToast('Не можете да добавите дублиран продукт!', 'error');
                    
                    submitButton.disabled = true;
                    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                    submitButton.textContent = 'Дублиран продукт - не може да се добави';
                    
                    return false;
                } else {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitButton.textContent = 'Добави продукт';
                    return true;
                }
            }
            
            return true;
        }
        
        // Add event listeners for real-time validation
        if (productNameInput) {
            productNameInput.addEventListener('blur', validateProduct);
            productNameInput.addEventListener('input', () => {
                setTimeout(validateProduct, 300); // Debounce
            });
        }
        
        if (drawingNumberInput) {
            drawingNumberInput.addEventListener('blur', validateProduct);
            drawingNumberInput.addEventListener('input', () => {
                setTimeout(validateProduct, 300); // Debounce
            });
        }
        
        // Validate on form submission
        productForm.addEventListener('submit', function(e) {
            if (!validateProduct()) {
                e.preventDefault();
                
                // Show a more prominent modal-style alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                alertDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium text-gray-900">Дублиран продукт!</h3>
                            </div>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-700">
                                Не можете да добавите дублиран продукт. Моля, променете името или номера на чертежа.
                            </p>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                Разбрах
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
                
                return false;
            }
        });
    }

    // Handle add dimension form submission
    document.getElementById('addDimensionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/add_dimension', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Clear form
                this.reset();
                // Reload dimensions
                loadDimensions(document.getElementById('productId').value);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding dimension');
        });
    });
});

// Show dimensions modal
function showDimensionsModal(productId, productName) {
    document.getElementById('modalProductName').textContent = productName;
    document.getElementById('productId').value = productId;
    document.getElementById('dimensionsModal').classList.remove('hidden');
    loadDimensions(productId);
}

// Close dimensions modal
function closeDimensionsModal() {
    document.getElementById('dimensionsModal').classList.add('hidden');
    document.getElementById('addDimensionForm').reset();
}

// Load dimensions for a product
function loadDimensions(productId) {
    fetch(`/get_dimensions/${productId}`)
        .then(response => response.json())
        .then(dimensions => {
            const tbody = document.querySelector('#dimensionsTable tbody');
            tbody.innerHTML = '';
            
            dimensions.forEach(dim => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dim.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="dimension-name">${dim.dimension_name}</span>
                        <input type="text" class="dimension-name-edit hidden w-full border rounded px-2 py-1" value="${dim.dimension_name}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="nominal-value">${dim.nominal_value}</span>
                        <input type="number" step="any" class="nominal-value-edit hidden w-full border rounded px-2 py-1" value="${dim.nominal_value}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="tolerance-minus">${dim.tolerance_minus}</span>
                        <input type="number" step="any" class="tolerance-minus-edit hidden w-full border rounded px-2 py-1" value="${dim.tolerance_minus}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="tolerance-plus">${dim.tolerance_plus}</span>
                        <input type="number" step="any" class="tolerance-plus-edit hidden w-full border rounded px-2 py-1" value="${dim.tolerance_plus}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="editDimension(${dim.id}, this)" class="text-blue-600 hover:text-blue-800 mr-2 edit-btn">Редактирай</button>
                        <button onclick="saveDimension(${dim.id}, this)" class="text-green-600 hover:text-green-800 mr-2 save-btn hidden">Запази</button>
                        <button onclick="cancelEdit(${dim.id}, this)" class="text-gray-600 hover:text-gray-800 mr-2 cancel-btn hidden">Отказ</button>
                        <button onclick="deleteDimension(${dim.id})" class="text-red-600 hover:text-red-800">Изтрий</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        });
}

// Edit dimension
function editDimension(dimensionId, button) {
    const row = button.closest('tr');
    
    // Show edit inputs
    row.querySelector('.dimension-name').classList.add('hidden');
    row.querySelector('.dimension-name-edit').classList.remove('hidden');
    row.querySelector('.nominal-value').classList.add('hidden');
    row.querySelector('.nominal-value-edit').classList.remove('hidden');
    row.querySelector('.tolerance-minus').classList.add('hidden');
    row.querySelector('.tolerance-minus-edit').classList.remove('hidden');
    row.querySelector('.tolerance-plus').classList.add('hidden');
    row.querySelector('.tolerance-plus-edit').classList.remove('hidden');
    
    // Show/hide buttons
    button.classList.add('hidden');
    row.querySelector('.save-btn').classList.remove('hidden');
    row.querySelector('.cancel-btn').classList.remove('hidden');
}

// Save dimension
function saveDimension(dimensionId, button) {
    const row = button.closest('tr');
    const formData = new FormData();
    formData.append('dimension_id', dimensionId);
    formData.append('dimension_name', row.querySelector('.dimension-name-edit').value);
    formData.append('nominal_value', row.querySelector('.nominal-value-edit').value);
    formData.append('tolerance_minus', row.querySelector('.tolerance-minus-edit').value);
    formData.append('tolerance_plus', row.querySelector('.tolerance-plus-edit').value);
    
    fetch('/update_dimension', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update display values
            row.querySelector('.dimension-name').textContent = row.querySelector('.dimension-name-edit').value;
            row.querySelector('.nominal-value').textContent = row.querySelector('.nominal-value-edit').value;
            row.querySelector('.tolerance-minus').textContent = row.querySelector('.tolerance-minus-edit').value;
            row.querySelector('.tolerance-plus').textContent = row.querySelector('.tolerance-plus-edit').value;
            
            // Hide edit mode
            cancelEdit(dimensionId, button);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating dimension');
    });
}

// Cancel edit
function cancelEdit(dimensionId, button) {
    const row = button.closest('tr');
    
    // Hide edit inputs
    row.querySelector('.dimension-name').classList.remove('hidden');
    row.querySelector('.dimension-name-edit').classList.add('hidden');
    row.querySelector('.nominal-value').classList.remove('hidden');
    row.querySelector('.nominal-value-edit').classList.add('hidden');
    row.querySelector('.tolerance-minus').classList.remove('hidden');
    row.querySelector('.tolerance-minus-edit').classList.add('hidden');
    row.querySelector('.tolerance-plus').classList.remove('hidden');
    row.querySelector('.tolerance-plus-edit').classList.add('hidden');
    
    // Show/hide buttons
    row.querySelector('.edit-btn').classList.remove('hidden');
    row.querySelector('.save-btn').classList.add('hidden');
    row.querySelector('.cancel-btn').classList.add('hidden');
}

// Delete dimension
function deleteDimension(dimensionId) {
    if (confirm('Are you sure you want to delete this dimension?')) {
        const formData = new FormData();
        formData.append('dimension_id', dimensionId);
        
        fetch('/delete_dimension', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload dimensions
                loadDimensions(document.getElementById('productId').value);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting dimension');
        });
    }
}

// Comment editing functions
function editComment(productId, button) {
    const row = button.closest('tr');
    const commentSpan = row.querySelector('.product-comment');
    const editForm = row.querySelector('.comment-edit-form');
    const textarea = editForm.querySelector('textarea');
    
    // Show edit form
    commentSpan.classList.add('hidden');
    editForm.classList.remove('hidden');
    textarea.focus();
}

function saveComment(productId, button) {
    const row = button.closest('tr');
    const commentSpan = row.querySelector('.product-comment');
    const editForm = row.querySelector('.comment-edit-form');
    const textarea = editForm.querySelector('textarea');
    const comments = textarea.value.trim();
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('comments', comments);
    
    fetch('/update_product_comments', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update display
            commentSpan.textContent = comments || 'Няма коментари';
            cancelCommentEdit(button);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating comments');
    });
}

function cancelCommentEdit(button) {
    const row = button.closest('tr');
    const commentSpan = row.querySelector('.product-comment');
    const editForm = row.querySelector('.comment-edit-form');
    
    // Hide edit form
    commentSpan.classList.remove('hidden');
    editForm.classList.add('hidden');
}

let currentDrawingSlot = 1;

function openUploadModal(slot = 1) {
    currentDrawingSlot = slot;
    document.getElementById('uploadModal').classList.remove('hidden');
    // Set or update the hidden input for drawing_slot
    let slotInput = document.getElementById('drawing_slot_input');
    if (!slotInput) {
        slotInput = document.createElement('input');
        slotInput.type = 'hidden';
        slotInput.id = 'drawing_slot_input';
        slotInput.name = 'drawing_slot';
        document.getElementById('uploadForm').appendChild(slotInput);
    }
    slotInput.value = slot;
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
    // Optionally clear the slot input
    let slotInput = document.getElementById('drawing_slot_input');
    if (slotInput) slotInput.value = '';
}

// Handle file upload
let isUploading = false;

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('Upload form submitted');
    
    // Prevent double submission
    if (isUploading) {
        console.log('Upload already in progress, ignoring duplicate submission');
        return;
    }
    
    isUploading = true;
    
    const formData = new FormData(this);
    // Ensure drawing_slot is included
    formData.set('drawing_slot', currentDrawingSlot);
    const fileInput = document.getElementById('drawing_file');
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        isUploading = false;
        return;
    }
    
    // Check file type
    const file = fileInput.files[0];
    if (!file.type.includes('pdf')) {
        alert('Only PDF files are allowed');
        isUploading = false;
        return;
    }
    
    // Check file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        isUploading = false;
        return;
    }
    
    console.log('Sending upload request to /upload_drawing');
    fetch('/upload_drawing', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Upload response received:', response.status, response.statusText);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.text().then(text => {
            console.log('Raw response text:', text);
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('JSON parse error:', e);
                console.error('Response text that failed to parse:', text);
                throw new Error('Invalid JSON response from server');
            }
        });
    })
    .then(data => {
        console.log('Upload response data:', data);
        if (data.status === 'success') {
            alert('Drawing uploaded successfully!');
            closeUploadModal();
            // Refresh the drawing path dropdown
            populateDrawingPath();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Error uploading file: ' + error.message);
    })
    .finally(() => {
        isUploading = false;
    });
});

function openReplaceModal(productId, drawingPath, drawingSlot = 1) {
    document.getElementById('replace_product_id').value = productId;
    document.getElementById('replaceForm').reset();
    document.getElementById('replaceModal').classList.remove('hidden');
    
    // Store the drawing slot for the replace operation
    let slotInput = document.getElementById('replace_drawing_slot');
    if (!slotInput) {
        slotInput = document.createElement('input');
        slotInput.type = 'hidden';
        slotInput.id = 'replace_drawing_slot';
        slotInput.name = 'drawing_slot';
        document.getElementById('replaceForm').appendChild(slotInput);
    }
    slotInput.value = drawingSlot;
}

function closeReplaceModal() {
    document.getElementById('replaceModal').classList.add('hidden');
}

document.getElementById('replaceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/replace_drawing', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Drawing replaced successfully');
            closeReplaceModal();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error replacing drawing');
    });
});

function deleteDrawing(productId, drawingPath, btn, drawingSlot = 1) {
    if (!confirm('Delete this drawing?')) return;
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('drawing_path', drawingPath);
    formData.append('drawing_slot', drawingSlot); // Use drawing_slot instead of type
    fetch('/delete_drawing', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Drawing deleted');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting drawing');
    });
}

// Add Drawing Modal Functions
function openAddDrawingModal(productId, drawingSlot = 1) {
    if (productId === 'new') {
        alert('Моля, първо създайте продукта, след което добавете чертежа от таблицата с продукти.');
        return;
    }
    document.getElementById('add_product_id').value = productId;
    document.getElementById('add_drawing_slot').value = drawingSlot;
    document.getElementById('addDrawingForm').reset();
    document.getElementById('addDrawingModal').classList.remove('hidden');
}

function closeAddDrawingModal() {
    document.getElementById('addDrawingModal').classList.add('hidden');
    document.getElementById('addDrawingForm').reset();
}

// Handle add drawing form submission
document.getElementById('addDrawingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const fileInput = document.getElementById('add_drawing_file');
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    // Check file type
    const file = fileInput.files[0];
    if (!file.type.includes('pdf')) {
        alert('Only PDF files are allowed');
        return;
    }
    
    // Check file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
    }
    
    fetch('/add_drawing_to_product', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Drawing added successfully!');
            closeAddDrawingModal();
            location.reload(); // Refresh to show the new drawing
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding drawing');
    });
});
</script>
{% endblock %}