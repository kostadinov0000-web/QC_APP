<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "base.html" %}
{% block title %}Reports & Analysis{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-6">Справки и анализи</h1>
<div class="bg-white p-6 rounded-lg shadow-md">
    <form method="POST">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-gray-700">Тип справка</label>
                <select name="report_type" class="w-full p-2 border rounded">
                    <option value="standard">Стандартна справка</option>
                    <option value="detailed">Детайлна справка</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700">Изберете продукт</label>
                <select name="product_id" class="w-full p-2 border rounded" required>
                    <option value="" disabled selected>Изберете продукт</option>
                    {% for product in products %}
                    <option value="{{ product['id'] }}">{{ product['product_name'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-gray-700">Период (ДД-ММ-ГГГГ)</label>
                <input type="text" name="start_date" value="{{ start_date }}"
                       class="w-full p-2 border rounded" required>
                <input type="text" name="end_date" value="{{ end_date }}"
                       class="w-full p-2 border rounded" required>
            </div>
        </div>
        <div class="flex gap-4">
            <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Генерирай справка</button>
            <button type="submit" form="excel-form" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Експорт в Excel</button>
        </div>
    </form>
    
    <!-- Separate form for Excel export -->
    <form id="excel-form" method="POST" action="/export_excel" class="hidden">
        <input type="hidden" name="report_type" id="excel_report_type">
        <input type="hidden" name="product_id" id="excel_product_id">
        <input type="hidden" name="start_date" id="excel_start_date">
        <input type="hidden" name="end_date" id="excel_end_date">
    </form>

    {% if report_data %}
    <table class="w-full border-collapse mt-6">
        <thead>
            <tr class="bg-gray-200">
                {% for header in headers %}
                <th class="p-2 border" {% if header == 'In Tolerance' or header == 'Tol. check' %}style="width: 32px; text-align: center;"{% endif %}>
                    {% if header == 'In Tolerance' %}Tol. check{% else %}{{ header }}{% endif %}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in report_data %}
            <tr>
                {% for header in headers %}
                <td class="p-2 border" {% if header == 'In Tolerance' or header == 'Tol. check' %}style="width: 32px; text-align: center;"{% endif %}>
                    {% if header == 'Product' %}
                        {{ row['product_name'] }}
                    {% elif header == 'Dimension' %}
                        {{ row['dimension_name'] }}
                    {% elif header == 'Measurements' %}
                        {{ row['count_measurements'] }}
                    {% elif header == 'Average' %}
                        {{ row['avg'] }}
                    {% elif header == 'Min' %}
                        {{ row['min'] }}
                    {% elif header == 'Max' %}
                        {{ row['max'] }}
                    {% elif header == 'Nominal' %}
                        {{ row['nominal_value'] }}
                    {% elif header == 'Tolerance' %}
                        {{ row['tolerance_plus'] }}
                    {% elif header == 'Measured Value' %}
                        {{ row['measured_value'] }}
                    {% elif header == 'Value' %}
                        {{ row['measured_value'] }}
                    {% elif header == 'Date' %}
                        {{ row['measurement_date'] }}
                    {% elif header == 'Measurement Date' %}
                        {{ row['measurement_date'] }}
                    {% elif header == 'Inspector' %}
                        {{ row['inspector'] }}
                    {% elif header == 'Machine' %}
                        {{ row['machine_number'] }}
                    {% elif header == 'Count' %}
                        {{ row['count'] }}
                    {% elif header == 'Tolerance (+/-)' %}
                        +{{ row['tolerance_plus'] }}/-{{ row['tolerance_minus'] }}
                    {% elif header == 'Shift' %}
                        {{ row['shift'] }}
                    {% elif header == 'In Tolerance' or header == 'Tol. check' %}
                        {% if row['in_tolerance'] %}
                            <span title="In tolerance" style="display:inline-block;width:16px;height:16px;background:#22c55e;border-radius:50%;vertical-align:middle;"></span>
                        {% else %}
                            <span title="Out of tolerance" style="display:inline-block;width:16px;height:16px;background:#ef4444;border-radius:50%;vertical-align:middle;"></span>
                        {% endif %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
        <h3 class="font-semibold text-yellow-800 mb-2">Няма намерени данни</h3>
        <p class="text-yellow-700">Няма измервания за избраните критерии. Моля, проверете:</p>
        <ul class="text-yellow-700 list-disc list-inside mt-2">
            <li>Периодът включва дати на измервания</li>
            <li>Избор на продукт (ако има)</li>
        </ul>
        <p class="text-yellow-700 mt-2">Налични измервания: Проверете базата данни за съществуващи данни.</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainForm = document.querySelector('form[method="POST"]:not(#excel-form)');
    const excelForm = document.getElementById('excel-form');
    
    // Sync form data when main form changes
    mainForm.addEventListener('change', function() {
        syncFormData();
    });
    
    // Sync form data when main form is submitted
    mainForm.addEventListener('submit', function() {
        syncFormData();
    });
    
    // Sync form data when Excel export is clicked
    excelForm.addEventListener('submit', function() {
        syncFormData();
    });
    
    function syncFormData() {
        const productId = mainForm.querySelector('select[name="product_id"]').value;
        const startDate = mainForm.querySelector('input[name="start_date"]').value;
        const endDate = mainForm.querySelector('input[name="end_date"]').value;
        const reportType = mainForm.querySelector('select[name="report_type"]').value;
        document.getElementById('excel_report_type').value = reportType;
        document.getElementById('excel_product_id').value = productId;
        document.getElementById('excel_start_date').value = startDate;
        document.getElementById('excel_end_date').value = endDate;
    }
    
    // Initial sync
    syncFormData();
});
</script>
{% endblock %}